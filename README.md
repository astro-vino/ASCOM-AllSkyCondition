# ASCOM Safety Monitor Driver for AllSkyCondition

This is an ASCOM SafetyMonitor driver that uses a machine learning model to determine sky conditions from an all-sky camera image. It can identify whether the sky is Clear, Cloudy, Covered, or Rainy and trigger an unsafe condition based on user-defined tolerances.

## Features

- Monitors an all-sky image file for changes in sky condition.
- Uses an ONNX machine learning model for image classification.
- Configurable cycle time and tolerances for cloudy or covered conditions.
- Triggers an ASCOM safety alert if conditions remain unsafe for a specified duration.

## Installation

1.  Build the solution in Visual Studio in `Release` mode.
2.  Install [NSIS](https://nsis.sourceforge.io/Download).
3.  Right-click `installer.nsi` and select "Compile NSIS Script".
4.  Run the generated `AllSkyCondition_v1.0.0.exe` installer.

## Configuration

After installing, you must configure the driver through your ASCOM-compatible astronomy software (e.g., N.I.N.A., SGP, etc.).

1.  **AllSky Image Path**: Set the full path to the image file generated by your all-sky camera (e.g., `\\<NAS>\AllSky\image.jpg`). The driver will monitor this file for updates.
2.  **Cycle Time (minutes)**: Specify how often the driver should check the image for new conditions.
3.  **Cloudy/Covered Tolerance (minutes)**: Set the number of minutes the sky can be continuously cloudy or covered before the driver reports an `IsSafe` status of `false`.

## Customizing the Model

The driver uses a pre-trained `model.onnx` file, but you can create your own model to better suit your camera and local conditions.

### 1. Create a New Keras Model

You can easily train a new image classification model using your own data with Google's [Teachable Machine](https://teachablemachine.withgoogle.com/).

- Create categories for your sky conditions (e.g., 'Clear', 'Cloudy', 'Rainy').
- Upload your training images for each category.
- Train the model and export it in the **Keras** (`.h5`) format.

### 2. Convert the Model to ONNX

The included `convert_model.py` script can be used to convert your new Keras model (`keras_model.h5`) into the `model.onnx` format used by the driver.

**Prerequisites:**
- Python 3
- `tensorflow`
- `tf2onnx`

To run the conversion:
```bash
pip install tensorflow tf2onnx
python convert_model.py
```

This will generate a new `model.onnx` file. Replace the existing model in the project with your new one and rebuild the solution and installer.
